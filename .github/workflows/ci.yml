name: CI/CD Pipeline

on:
  push:
    branches: [main, develop, "fix/*"]
    tags: ["v*"]
    paths-ignore: ["**.md", "docs/**"]
  pull_request:
    branches: [main, develop, "feature/*"]
    paths-ignore: ["**.md", "docs/**"]
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "testflight"
        type: choice
        options:
          - testflight
          - appstore

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 1. Code Quality & Linting
  quality-checks:
    name: Code Quality
    runs-on: macos-latest
    timeout-minutes: 15

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "6.2"

      - name: Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Caches/org.swift.swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Install SwiftFormat (Pinned)
        run: |
          if ! command -v swiftformat >/dev/null 2>&1 || [ "$(swiftformat --version)" != "0.59.1" ]; then
            brew install swiftformat
          fi
          swiftformat --version

      - name: SwiftFormat Check
        run: |
          if command -v swiftformat >/dev/null 2>&1; then
            swiftformat . --config .swiftformat --lint --verbose
          else
            echo "SwiftFormat check skipped (not installed)"
          fi

      - name: SwiftLint
        run: |
          if command -v swiftlint >/dev/null 2>&1; then
            swiftlint --strict --reporter github-actions-logging
          else
            echo "SwiftLint check skipped (not installed)"
          fi

  # 2. Security Scanning
  security-scan:
    name: Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"
          ignore-unfixed: true

      - name: Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

      - name: Check for Secrets (TruffleHog)
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.before }}
          head: ${{ github.sha }}
          extra_args: --debug --only-verified

      - name: CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # 3. Build & Test
  build-and-test:
    name: Build and Test
    runs-on: macos-latest
    timeout-minutes: 45
    needs: quality-checks
    strategy:
      fail-fast: false
      matrix:
        include:
          - destination: "platform=iOS Simulator,name=iPhone 17,OS=latest"
            name: iOS
            scheme: AvoidObstaclesGame

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Prepare shared-kit dependency
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SHARED_KIT_REPO="https://x-access-token:${GH_TOKEN}@github.com/dboone323/shared-kit.git"
          SHARED_KIT_REF="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME:-main}}"
          if ! git clone --depth 1 --branch "$SHARED_KIT_REF" "$SHARED_KIT_REPO" "$RUNNER_TEMP/shared-kit"; then
            echo "Falling back to default branch for shared-kit"
            rm -rf "$RUNNER_TEMP/shared-kit"
            git clone --depth 1 "$SHARED_KIT_REPO" "$RUNNER_TEMP/shared-kit"
          fi
          ln -sfn "$RUNNER_TEMP/shared-kit" "$GITHUB_WORKSPACE/../shared-kit"

      - name: Build (${{ matrix.name }})
        run: |
          echo "Building ${{ matrix.name }}..."
          xcodebuild build \
            -scheme ${{ matrix.scheme }} \
            -destination '${{ matrix.destination }}' \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Run Tests (${{ matrix.name }})
        run: |
          echo "Running tests on ${{ matrix.name }}..."
          rm -rf TestResults.xcresult
          xcodebuild test \
            -scheme ${{ matrix.scheme }} \
            -destination '${{ matrix.destination }}' \
            -configuration Debug \
            -enableCodeCoverage YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -resultBundlePath TestResults.xcresult

  # 5. Quality Gate
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [quality-checks, build-and-test, security-scan]
    if: always()
    steps:
      - name: Evaluate
        run: |
          if [ "${{ needs.quality-checks.result }}" = "success" ] && \
             [ "${{ needs.build-and-test.result }}" = "success" ] && \
             [ "${{ needs.security-scan.result }}" = "success" ]; then
            echo "All checks passed!"
            exit 0
          else
            echo "Workflow failed."
            exit 1
          fi
